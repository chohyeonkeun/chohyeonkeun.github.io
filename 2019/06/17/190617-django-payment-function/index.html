<!DOCTYPE html>
<html lang="ko">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="naver-site-verification" content="c017b080593f962c8c0a7ca644404511803c6484">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="신입개발자 조누스로써의 역량을 키워가는 과정이 담겨있는 개발로그입니다.">
  <meta property="og:title" content="조누스의 걸음마 개발로그">
  <meta property="og:description" content="안녕하세요 열정괴물 신입개발자 조누스의 개발로그입니다.">
  <meta property="og:url" content="https://chohyeonkeun.github.io">
  <title>장고 - 결제 시스템 연동 | 조누스의 걸음마 개발 로그</title>
  
  
  
  <link rel="canonical" href="https://jonusHK.github.io/2019/06/17/190617-django-payment-function/">
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class="SideBar">
    <section class="avatar" style="background-image: url()">
        <div class="av-pic" style="background-image: url(/assets/me.jpg)">
        </div>
    </section>
    <section class="menu">
	<div>웹 프로그래머</div>
        <div style="font-weight: bold">조누스의 걸음마 개발 로그</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/tags/" class="Btn">
              <li>Tags</li>
            </a>  
          
            <a href="/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
            
                <a href="https://github.com/chohyeonkeun">
                    <img src="/assets/github.svg">
                </a>
            
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class="ContentView">
    <header class="PageTitle">
        <h1>장고 - 결제 시스템 연동</h1>
    </header>

    <section>
      <ul>
<li>이번 포스트에서는 온라인 쇼핑몰 사이트를 예로 들어, 결제 시스템을 어떻게 연동하는지에 대해 알아볼 것이다.</li>
<li>여기에서는 iamport를 사용하여 결제 시스템을 연동할 것이다.</li>
</ul>
<a id="more"></a>
<hr>
<h2 id="iamport-결제-관리-시스템-이용"><a href="#iamport-결제-관리-시스템-이용" class="headerlink" title="iamport 결제 관리 시스템 이용"></a>iamport 결제 관리 시스템 이용</h2><h3 id="1-iamport-사이트-접속"><a href="#1-iamport-사이트-접속" class="headerlink" title="1. iamport 사이트 접속"></a>1. iamport 사이트 접속</h3><ul>
<li><a href="https://www.iamport.kr" target="_blank" rel="noopener">https://www.iamport.kr</a></li>
<li>우측 상단 ‘대사보드’ 클릭</li>
<li>회원가입 및 로그인</li>
<li>시스템설정 &gt; PG설정(일반결제 및 정기결제)<ul>
<li>PG사 : KG이니시스(웹표준결제창) 선택</li>
<li>테스트모드 : ON</li>
</ul>
</li>
</ul>
<h3 id="2-장고-프로젝트에-IAMPORT-관련-정보-설정"><a href="#2-장고-프로젝트에-IAMPORT-관련-정보-설정" class="headerlink" title="2. 장고 프로젝트에 IAMPORT 관련 정보 설정"></a>2. 장고 프로젝트에 IAMPORT 관련 정보 설정</h3><ul>
<li>경로 : config(프로젝트) &gt; settings.py  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># iamport 사이트 &gt; 시스템설정 &gt; 내정보에서 IAMPORT_KEY, IAMPORT_SECRET 정보 입력</span></span><br><span class="line">IAMPORT_KEY = <span class="string">'REST API 키'</span></span><br><span class="line">IAMPORT_SECRET = <span class="string">'REST API secret'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-장바구니-페이지에서-결제-버튼-클릭-시-결제페이지로-이동되도록-코드-작성"><a href="#3-장바구니-페이지에서-결제-버튼-클릭-시-결제페이지로-이동되도록-코드-작성" class="headerlink" title="3. 장바구니 페이지에서 결제 버튼 클릭 시, 결제페이지로 이동되도록 코드 작성"></a>3. 장바구니 페이지에서 결제 버튼 클릭 시, 결제페이지로 이동되도록 코드 작성</h3><ul>
<li>경로 : cart &gt; templates &gt; cart &gt; cart.detail.html  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">&lt;!-- 클릭 시, 결제페이지로 이동되는 버튼 부분 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 이전 페이지 이동 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;continue_url&#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"float-left btn btn-lg btn-primary"</span>&gt;</span>Continue Shopping<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 결제페이지로 이동 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'order_create' %&#125;"</span> <span class="attr">class</span>=<span class="string">"float-right btn btn-lg btn-info"</span>&gt;</span>Checkout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="4-결제-페이지로-이동할-경로-작성"><a href="#4-결제-페이지로-이동할-경로-작성" class="headerlink" title="4. 결제 페이지로 이동할 경로 작성"></a>4. 결제 페이지로 이동할 경로 작성</h3><ul>
<li>경로 : order &gt; urls.py  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> *</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'create/'</span>, order_create, name=<span class="string">'order_create'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="5-결제-페이지-코드-작성"><a href="#5-결제-페이지-코드-작성" class="headerlink" title="5. 결제 페이지 코드 작성"></a>5. 결제 페이지 코드 작성</h3><ul>
<li><p>경로 : order &gt; views.py</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cart.cart <span class="keyword">import</span> Cart</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> OrderItem</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> OrderForm</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_create</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 장바구니에 존재하는 상품 정보 받아오기</span></span><br><span class="line">    cart = Cart(request)</span><br><span class="line">    <span class="comment"># 주문 정보가 입력 완료된 상황(결제 폼 작성 완료하여 POST 형태로 request를 받은 상황)</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        form = OrderForm(request.POST)</span><br><span class="line">        <span class="comment"># 작성한 폼 validation 진행</span></span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            order = form.save()</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> cart:</span><br><span class="line">                <span class="comment"># 장바구니에 들어있는 모든 상품 정보를 OrderItem 모델에 저장</span></span><br><span class="line">                OrderItem.objects.create(order=order, product=item[<span class="string">'product'</span>], price=item[<span class="string">'price'</span>], quantity=item[<span class="string">'quantity'</span>])</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">'order/order_created.html'</span>, &#123;<span class="string">'order'</span>: order&#125;)</span><br><span class="line">    <span class="comment"># 주문 정보가 입력되지 않은 상황(처음 결제페이지로 이동한 상황)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = OrderForm()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'order/order_create.html'</span>, &#123;<span class="string">'form'</span>:form&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>경로 : order &gt; templates &gt; order &gt; order_create.html</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">Order Checkout</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"alert alert-info mt-3"</span>&gt;</span></span><br><span class="line">    Please enter your order information.</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">class</span>=<span class="string">"order-form"</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &#123;&#123;form.as_p&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"pre_order_id"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"amount"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123;cart.get_total_price&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Payment"</span> <span class="attr">class</span>=<span class="string">"btn btn-lg btn-success"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block extra_script %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">csrf_token = <span class="string">'&#123;&#123;csrf_token&#125;&#125;'</span>;</span></span><br><span class="line"><span class="javascript">order_create_url = <span class="string">'&#123;% url '</span>order_create_ajax<span class="string">' %&#125;'</span>;</span></span><br><span class="line"><span class="javascript">order_checkout_url = <span class="string">'&#123;% url '</span>order_checkout<span class="string">' %&#125;'</span>;</span></span><br><span class="line"><span class="javascript">order_validation_url = <span class="string">'&#123;% url '</span>order_validation<span class="string">' %&#125;'</span>;</span></span><br><span class="line"><span class="javascript">order_complete_url = <span class="string">'&#123;% url '</span>order_complete<span class="string">' %&#125;'</span>;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- iamport 사이트에서 해당 스크립트 복사 붙여넣기--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 결제창 띄우기 위한 자바스크립트 실행 --&gt;</span></span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/checkout.js' %&#125;"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="6-결제창-실행시키기-위해-필요한-자바스크립트-관련-view의-경로-설정"><a href="#6-결제창-실행시키기-위해-필요한-자바스크립트-관련-view의-경로-설정" class="headerlink" title="6. 결제창 실행시키기 위해 필요한 자바스크립트 관련 view의 경로 설정"></a>6. 결제창 실행시키기 위해 필요한 자바스크립트 관련 view의 경로 설정</h3><ul>
<li>경로 : order &gt; urls.py  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> *</span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">'create_ajax/'</span>, OrderCreateAjaxView.as_view(), name=<span class="string">'order_create_ajax'</span>),</span><br><span class="line">    path(<span class="string">'checkout/'</span>, OrderCheckoutAjaxView.as_view(), name=<span class="string">'order_checkout'</span>),</span><br><span class="line">    path(<span class="string">'validation/'</span>, OrderImpAjaxView.as_view(), name=<span class="string">'order_validation'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="7-결제창-실행시키기-위해-필요한-자바스크립트-관련-view-작성"><a href="#7-결제창-실행시키기-위해-필요한-자바스크립트-관련-view-작성" class="headerlink" title="7. 결제창 실행시키기 위해 필요한 자바스크립트 관련 view 작성"></a>7. 결제창 실행시키기 위해 필요한 자바스크립트 관련 view 작성</h3><ul>
<li>경로 : order &gt; views.py  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cart.cart <span class="keyword">import</span> Cart</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> OrderItem</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> OrderForm</span><br><span class="line"><span class="keyword">from</span> django.views.generic.base <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderCreateAjaxView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        cart = Cart(request)</span><br><span class="line">        form = OrderForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            order = form.save()</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> cart:</span><br><span class="line">                OrderItem.objects.create(order=order, product=item[<span class="string">'product'</span>], price=item[<span class="string">'price'</span>], quantity=item[<span class="string">'quantity'</span>])</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">"order_id"</span>:order.id</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(data)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;&#125;, status=<span class="number">401</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> OrderTransaction</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderCheckoutAjaxView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        order_id = request.POST.get(<span class="string">'order_id'</span>)</span><br><span class="line">        order = Order.objects.get(id=order_id)</span><br><span class="line">        amount = request.POST.get(<span class="string">'amount'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            merchant_order_id = OrderTransaction.objects.create_new(order=order, amount=amount)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            merchant_order_id = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> merchant_order_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">'works'</span>:<span class="literal">True</span>,</span><br><span class="line">                <span class="string">'merchant_id'</span>:merchant_order_id</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;&#125;, status=<span class="number">401</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderImpAjaxView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        order_id = request.POST.get(<span class="string">'order_id'</span>)</span><br><span class="line">        merchant_id = request.POST.get(<span class="string">'merchant_id'</span>)</span><br><span class="line">        imp_id = request.POST.get(<span class="string">'imp_id'</span>)</span><br><span class="line">        amount = request.POST.get(<span class="string">'amount'</span>)</span><br><span class="line">        order = Order.objects.filter(pk=order_id)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> order.exists():</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;&#125;, status=<span class="number">401</span>)</span><br><span class="line"></span><br><span class="line">        order = order[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        transaction = OrderTransaction.objects.filter(order=order, merchant_order_id=merchant_id, amount=amount)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> transaction.exists():</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;&#125;, status=<span class="number">401</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 결제 정보 수정</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            exact_transaction = transaction[<span class="number">0</span>]</span><br><span class="line">            exact_transaction.transaction_id = imp_id</span><br><span class="line">            exact_transaction.success = <span class="literal">True</span></span><br><span class="line">            exact_transaction.save()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 주문 정보 - 결제 완료로 변경</span></span><br><span class="line">            order.paid = <span class="literal">True</span></span><br><span class="line">            order.save()</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">'works'</span>:<span class="literal">True</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cart = Cart(request)</span><br><span class="line">            cart.clear()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(data)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">"transaction error"</span>, e)</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">"message"</span>:str(e)&#125;, status=<span class="number">401</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="8-iamport-API와-통신하는-함수-작성"><a href="#8-iamport-API와-통신하는-함수-작성" class="headerlink" title="8. iamport API와 통신하는 함수 작성"></a>8. iamport API와 통신하는 함수 작성</h3><ul>
<li>경로 : order &gt; iamport.py  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iamport 가입 - 설정</span></span><br><span class="line"><span class="comment"># iamport API와 통신하는 함수 만들기</span></span><br><span class="line"><span class="comment"># views.py API함수를 이용한 결제 진행</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line"><span class="comment"># pip install requests</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_token</span><span class="params">()</span>:</span></span><br><span class="line">    access_data = &#123;</span><br><span class="line">        <span class="string">'imp_key'</span>:settings.IAMPORT_KEY,</span><br><span class="line">        <span class="string">'imp_secret'</span>:settings.IAMPORT_SECRET</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    url = <span class="string">'https://api.iamport.kr/users/getToken'</span></span><br><span class="line"></span><br><span class="line">    req = requests.post(url, data=access_data)</span><br><span class="line">    data = req.json()</span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">'code'</span>] <span class="keyword">is</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> data[<span class="string">'response'</span>][<span class="string">'access_token'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iamport에 사전 정보를 보내서 결제 준비</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payment_prepare</span><span class="params">(order_id, amount, *args, **kwargs)</span>:</span></span><br><span class="line">    access_token = get_token()</span><br><span class="line">    <span class="keyword">if</span> access_token:</span><br><span class="line">        access_data = &#123;</span><br><span class="line">            <span class="string">'merchant_uid'</span>:order_id,</span><br><span class="line">            <span class="string">'amount'</span>:amount</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        url = <span class="string">"https://api.iamport.kr/payments/prepare"</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">'Authorization'</span>:access_token</span><br><span class="line">        &#125;</span><br><span class="line">        req = requests.post(url, data=access_data, headers=headers)</span><br><span class="line">        data = req.json()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">'code'</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"API 통신 오류"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"토큰 오류"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 결제 이후에 해당 하는 주문 번호와 결제 금액으로 진행된 결제가 있는지 찾아주는 함수</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_transaction</span><span class="params">(order_id, *args, **kwargs)</span>:</span></span><br><span class="line">    access_token = get_token()</span><br><span class="line">    <span class="keyword">if</span> access_token:</span><br><span class="line">        url = <span class="string">"https://api.iamport.kr/payments/find/"</span>+order_id</span><br><span class="line">        headers = &#123;<span class="string">'Authorization'</span>:access_token&#125;</span><br><span class="line">        req = requests.post(url, headers=headers)</span><br><span class="line">        data = req.json()</span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">'code'</span>] <span class="keyword">is</span> <span class="number">0</span>:</span><br><span class="line">            imp_data = data[<span class="string">'response'</span>]</span><br><span class="line">            context = &#123;</span><br><span class="line">                <span class="string">'imp_id'</span>: imp_data[<span class="string">'imp_uid'</span>],</span><br><span class="line">                <span class="string">'merchant_order_id'</span>: imp_data[<span class="string">'merchant_uid'</span>],</span><br><span class="line">                <span class="string">'amount'</span>:imp_data[<span class="string">'amount'</span>],</span><br><span class="line">                <span class="string">'status'</span>:imp_data[<span class="string">'status'</span>],</span><br><span class="line">                <span class="string">'type'</span>:imp_data[<span class="string">'pay_method'</span>],</span><br><span class="line">                <span class="string">'receipt_url'</span>:imp_data[<span class="string">'receipt_url'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> context</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"토큰 오류"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cancel_transaction</span><span class="params">(transaction_id, *args, **kwargs)</span>:</span></span><br><span class="line">    access_token = get_token()</span><br><span class="line">    <span class="keyword">if</span> access_token:</span><br><span class="line">        url = <span class="string">"https://api.iamport.kr/payments/cancel"</span></span><br><span class="line">        headers = &#123;<span class="string">'Authorization'</span>:access_token&#125;</span><br><span class="line">        access_data = &#123;</span><br><span class="line">            <span class="string">'imp_uid'</span>: transaction_id</span><br><span class="line">        &#125;</span><br><span class="line">        print(<span class="string">"data"</span>, access_data)</span><br><span class="line">        req = requests.post(url, data=access_data, headers=headers)</span><br><span class="line">        data = req.json()</span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">'code'</span>] <span class="keyword">is</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"토큰 오류"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="9-결제창-띄우기-위한-자바스크립트-코드-작성"><a href="#9-결제창-띄우기-위한-자바스크립트-코드-작성" class="headerlink" title="9. 결제창 띄우기 위한 자바스크립트 코드 작성"></a>9. 결제창 띄우기 위한 자바스크립트 코드 작성</h3><ul>
<li>경로 : order &gt; static &gt; js &gt; checkout.js  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> IMP = <span class="built_in">window</span>.IMP;</span><br><span class="line">    IMP.init(<span class="string">'iamport 사이트에서 가맹점 식별코드 입력'</span>);</span><br><span class="line">    $(<span class="string">'.order-form'</span>).on(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> amount = <span class="built_in">parseFloat</span>($(<span class="string">'.order-form input[name="amount"]'</span>).val().replace(<span class="string">','</span>, <span class="string">''</span>));</span><br><span class="line">        <span class="keyword">var</span> type = $(<span class="string">'.order-form input[name="type"]:checked'</span>).val();</span><br><span class="line">        <span class="comment">// 폼 데이터를 기준으로 주문 생성</span></span><br><span class="line">        <span class="keyword">var</span> order_id = AjaxCreateOrder(e);</span><br><span class="line">        <span class="keyword">if</span> (order_id == <span class="literal">false</span>) &#123;</span><br><span class="line">            alert(<span class="string">'주문 생성 실패\n다시 시도해주세요.'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 결제 정보 생성</span></span><br><span class="line">        <span class="keyword">var</span> merchant_id = AjaxStoreTransaction(e, order_id, amount, type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 결제 정보가 만들어졌으면 iamport로 실제 결제 시도</span></span><br><span class="line">        <span class="keyword">if</span> (merchant_id !== <span class="string">''</span>) &#123;</span><br><span class="line">            IMP.request_pay(&#123;</span><br><span class="line">                merchant_uid: merchant_id,</span><br><span class="line">                name: <span class="string">'E-Shop product'</span>,</span><br><span class="line">                buyer_name:$(<span class="string">'input[name="first_name"]'</span>).val()+<span class="string">" "</span>+$(<span class="string">'input[name="last_name"]'</span>).val(),</span><br><span class="line">                buyer_email:$(<span class="string">'input[name="email"]'</span>).val(),</span><br><span class="line">                amount: amount</span><br><span class="line">            &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">rsp</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (rsp.success) &#123;</span><br><span class="line">                    <span class="keyword">var</span> msg = <span class="string">'결제가 완료되었습니다.'</span>;</span><br><span class="line">                    msg += <span class="string">'고유ID : '</span> + rsp.imp_uid;</span><br><span class="line">                    msg += <span class="string">'상점 거래ID : '</span> + rsp.merchant_uid;</span><br><span class="line">                    msg += <span class="string">'결제 금액 : '</span> + rsp.paid_amount;</span><br><span class="line">                    msg += <span class="string">'카드 승인번호 : '</span> + rsp.apply_num;</span><br><span class="line">                    <span class="comment">// 결제가 완료되었으면 비교해서 디비에 반영</span></span><br><span class="line">                    ImpTransaction(e, order_id, rsp.merchant_uid, rsp.imp_uid, rsp.paid_amount);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">var</span> msg = <span class="string">'결제에 실패하였습니다.'</span>;</span><br><span class="line">                    msg += <span class="string">'에러내용 : '</span> + rsp.error_msg;</span><br><span class="line">                    <span class="built_in">console</span>.log(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 폼 데이터를 기준으로 주문 생성</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AjaxCreateOrder</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> order_id = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> request = $.ajax(&#123;</span><br><span class="line">        method: <span class="string">"POST"</span>,</span><br><span class="line">        url: order_create_url,</span><br><span class="line">        <span class="keyword">async</span>: <span class="literal">false</span>,</span><br><span class="line">        data: $(<span class="string">'.order-form'</span>).serialize()</span><br><span class="line">    &#125;);</span><br><span class="line">    request.done(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data.order_id) &#123;</span><br><span class="line">            order_id = data.order_id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    request.fail(<span class="function"><span class="keyword">function</span> (<span class="params">jqXHR, textStatus</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jqXHR.status == <span class="number">404</span>) &#123;</span><br><span class="line">            alert(<span class="string">"페이지가 존재하지 않습니다."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jqXHR.status == <span class="number">403</span>) &#123;</span><br><span class="line">            alert(<span class="string">"로그인 해주세요."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">"문제가 발생했습니다. 다시 시도해주세요."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> order_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 결제 정보 생성</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AjaxStoreTransaction</span>(<span class="params">e, order_id, amount, type</span>) </span>&#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> merchant_id = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> request = $.ajax(&#123;</span><br><span class="line">        method: <span class="string">"POST"</span>,</span><br><span class="line">        url: order_checkout_url,</span><br><span class="line">        <span class="keyword">async</span>: <span class="literal">false</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            order_id : order_id,</span><br><span class="line">            amount: amount,</span><br><span class="line">            type: type,</span><br><span class="line">            csrfmiddlewaretoken: csrf_token,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    request.done(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data.works) &#123;</span><br><span class="line">            merchant_id = data.merchant_id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    request.fail(<span class="function"><span class="keyword">function</span> (<span class="params">jqXHR, textStatus</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jqXHR.status == <span class="number">404</span>) &#123;</span><br><span class="line">            alert(<span class="string">"페이지가 존재하지 않습니다."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jqXHR.status == <span class="number">403</span>) &#123;</span><br><span class="line">            alert(<span class="string">"로그인 해주세요."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">"문제가 발생했습니다. 다시 시도해주세요."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> merchant_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// iamport에 결제 정보가 있는지 확인 후 결제 완료 페이지로 이동</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ImpTransaction</span>(<span class="params">e, order_id,merchant_id, imp_id, amount</span>) </span>&#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> request = $.ajax(&#123;</span><br><span class="line">        method: <span class="string">"POST"</span>,</span><br><span class="line">        url: order_validation_url,</span><br><span class="line">        <span class="keyword">async</span>: <span class="literal">false</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            order_id:order_id,</span><br><span class="line">            merchant_id: merchant_id,</span><br><span class="line">            imp_id: imp_id,</span><br><span class="line">            amount: amount,</span><br><span class="line">            csrfmiddlewaretoken: csrf_token</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    request.done(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data.works) &#123;</span><br><span class="line">            $(location).attr(<span class="string">'href'</span>, location.origin+order_complete_url+<span class="string">'?order_id='</span>+order_id)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    request.fail(<span class="function"><span class="keyword">function</span> (<span class="params">jqXHR, textStatus</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jqXHR.status == <span class="number">404</span>) &#123;</span><br><span class="line">            alert(<span class="string">"페이지가 존재하지 않습니다."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jqXHR.status == <span class="number">403</span>) &#123;</span><br><span class="line">            alert(<span class="string">"로그인 해주세요."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(jqXHR);</span><br><span class="line">            alert(<span class="string">"문제가 발생했습니다. 다시 시도해주세요."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>


      

    </section>
    
      <section class="ArticleMeta">
          <div>
            Posted &nbsp;
            <time datetime="2019-06-17T08:00:21.000Z" itemprop="datePublished">
              2019-06-17
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/tags/Django/">Django</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/order/">order</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/payment/">payment</a> }
  </li>


            </div>
          
      </section>
    
    
</article>

  
</div>

            <footer>
    <div>© 2021 - 조현근 </div>
    <div>
        <span>
            Powered by <a href="https://hexo.io">Hexo</a>
        </span>
        ,
        <span>
            Theme - <a href="https://github.com/nameoverflow/hexo-theme-icalm">Icalm</a>
        </span>
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>
